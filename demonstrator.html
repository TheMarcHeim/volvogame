<html>
<head>
<meta charset="utf-8"/>
<script src="https://cdn.jsdelivr.net/npm/graphhopper-js-api-client/dist/graphhopper-client.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<link href="https://fonts.googleapis.com/css?family=Quicksand" rel="stylesheet">
<script type="text/javascript">
var scalex = 21;
var scaley = 11.5;
var mapCenter = [40.714728,-73.998672]

var passengerList;
var count = 0;
var lastInd = -1;
var lastLoc = null;
var lastType = 0;
var lastComputedInd = -1;
var lastMouseX = 0;
var lastMouseY = 0;
var canFinish = 1;
var finished = 0;
var directDist = 0;
var totalDist = 0;
var start = [40.705086,-74.016711];
var target = [40.734967,-73.992850];

function onload(){
    setup();  
    passengerList = getPassengers();
    drawPassengers(passengerList);
    drawPassengerArrows()
}

$(document).ready(function(){

    $(".options").attr("data-option", "driver");
    $(".options").html("I want to be driven");

    function clickEventHandler() {
        if ($(this).attr("data-option") == "driver") {
            //clearCanvases();
            $(this).attr("data-option", "passenger");
            $(this).html("I want to drive");
            reset(0);
        } else {
            //clearCanvases();
            $(this).attr("data-option", "driver");
            $(this).html("I want to be driven");
            reset(1);
        }
    }

    $(".options").on("click", clickEventHandler);
});

function getDirectDist() {
    var ghRouting = new GraphHopper.Routing({
	      key: "792f5935-6974-4c19-9ada-2742bbcdc54f",
	      vehicle: "car",
	      elevation: false
	    });

	    ghRouting.addPoint(new GHInput(start[0], start[1]));
	    ghRouting.addPoint(new GHInput(target[0], target[1]));

	    ghRouting.doRequest().then(function(json) {
		    //console.log(json);
            console.log(json);
            directDist = json.paths[0].distance;
	    }).catch(function(err) {
		    console.error(err.message);
	    });
}

function clearCanvases() {
    var canvas = document.getElementById("canvas");
    canvas.innerHTML = "";
	var ctx = canvas.getContext("2d");
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.beginPath();
    var icanvas = document.getElementById("icanvas");
    icanvas.innerHTML = "";
    ctx = canvas.getContext("2d");
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.beginPath();
}

function drawPath(from, to){

    var ghRouting = new GraphHopper.Routing({
	      key: "792f5935-6974-4c19-9ada-2742bbcdc54f",
	      vehicle: "car",
	      elevation: false
	    });

	    ghRouting.addPoint(new GHInput(from[0], from[1]));
	    ghRouting.addPoint(new GHInput(to[0], to[1]));

	    ghRouting.doRequest().then(function(json) {
		    //console.log(json);
            console.log(json);
	    var canvas = document.getElementById("canvas");
	    var ctx = canvas.getContext("2d");
		ctx.lineWidth=10;
		ctx.lineCap="round";
		ctx.strokeStyle = 'rgba(165,177,248,0.5)';
	    ctx.clearRect(0, 0, canvas.width, canvas.height);
	    ctx.beginPath();
	    ctx.moveTo(pointlist[0][0], pointlist[0][1]);

	    pointlist.forEach(point => {
		ctx.lineTo(point[0], point[1]);
		ctx.stroke();
		ctx.moveTo(point[0], point[1]);
	    });
	
	    }).catch(function(err) {
		    console.error(err.message);
	    });
}

function onMouseMove(e) {
	updateStraightLines(e.pageX,e.pageY);
	lastMouseX=e.pageX;
	lastMouseY=e.pageY;
}

function setup()
{
    map = document.getElementById("map");
    canvas = document.getElementById("canvas");
    canvas.width = document.body.clientWidth;
    canvas.height = document.body.clientHeight; 

    icanvas = document.getElementById("icanvas");
    icanvas.width = document.body.clientWidth;
    icanvas.height = document.body.clientHeight; 

    finished = false;
    lastInd = -1;
    lastLoc = null;
    lastType = 0;
    lastComputedInd = -1;

    getDirectDist();

    var ctx = canvas.getContext("2d");
    ctx.moveTo(0,0);
    ctx.lineTo(200,100);
    ctx.stroke();
	$("body").mousemove(onMouseMove);
    //reset(0);
}



function reset(driving) {
	if (driving) {
        clearCanvases();
	    setup();
	    passengerList = getPassengers();
	    drawPassengers(passengerList);
	    drawPassengerArrows();
	} else {
	    clearCanvases();
	    $('.passenger').remove();
	    $('.start').remove();
	    $('.target').remove();
	    $('.passengertarget').remove();
	}

    $(".options").on("click", function() {
        if ($(this).attr("data-option") == "driver") {
            //clearCanvases();
            $(this).attr("data-option", "passenger");
            $(this).html("I want to drive");
            reset(0);
        } else {
            //clearCanvases();
            $(this).attr("data-option", "driver");
            $(this).html("I want to be driven");
            reset(1);
        }
    });
}

function updateStraightLines(x,y) {
	if (!finished) {
	    var canvas = document.getElementById("icanvas");
	    var ctx = canvas.getContext("2d");

	    ctx.lineWidth=10;
	    ctx.lineCap="round";
	    ctx.strokeStyle = 'rgba(0,0,0,0.5)';
	    ctx.clearRect(0, 0, canvas.width, canvas.height);
	    ctx.beginPath();

	    if (lastInd!=-1) {
            st = lastLoc;
            ta = globalToLocal(target);
            ctx.moveTo(st[0],st[1]);
            ctx.lineTo(x, y);
            ctx.setLineDash([5, 15]);
            ctx.lineTo(ta[0],ta[1]);
            ctx.stroke();
	    } else {
            st = globalToLocal(start);
            ta = globalToLocal(target);
            ctx.moveTo(st[0],st[1]);
            ctx.lineTo(x, y);
            ctx.setLineDash([5, 15]);
            ctx.lineTo(ta[0],ta[1]);
            ctx.stroke();
        }
	}
}

function testrouting(){
	var points = [start, target];
	getRouteData(points, drawRoute);
}

function testpoint(p) {
	var points = [start, localToGlobal(p)];
	getRouteData(points, drawRoute);
}

function recomputeRoute(passengers) {

	//sort for count

	passengers.sort(function(a, b) {
	    return a.count - b.count;
	});
	if (passengers.length > 0) {
	    lastInd = passengers[passengers.length-1].index;
        if (lastType) {
            lastLoc = globalToLocal(passengers[passengers.length-1].targetlocation);
        } else {
            lastLoc = globalToLocal(passengers[passengers.length-1].location);
        }
    }
	var points = [start];
	passengers.forEach(passenger => {
		points.push(passenger.location);
	});

	tpassengers = [].concat(passengers);
	tpassengers.sort(function(a, b) {
	    return a.tcount - b.tcount;
	});

	var i = 0;
	var points = [start];
	//this is horrible
	    passengers.forEach(passenger => {
            while(i < tpassengers.length && tpassengers[i].tcount < passenger.count) {
                if(tpassengers[i].done){
                    points.push(tpassengers[i].targetlocation);}
                i++;
		    }
		    points.push(passenger.location);
	    });

	    while (i<tpassengers.length) {
		    if (tpassengers[i].done) {
			    points.push(tpassengers[i].targetlocation);}
		    i++;
	    }
	if (finished) {
		points.push(target);
	}
	//check if all passengers are delivered
	var hasLeftInCar = 0;
	passengers.forEach(passenger => {
		if (!passenger.done) {
			hasLeftInCar=1;
        }
	});
	if (hasLeftInCar) {
        canFinish = 0;
		$("#tFlag").css("background-image", "url('redflag.png')");
	} else {
        canFinish = 1;
		$("#tFlag").css("background-image", "url('greenflag.png')");
	}
	if (finished) {
		$("#tFlag").css("background-image", "url('checkflag.png')");
	}
	var miles = getFreeMiles(passengers);
    
	
	$(".incentiveDisplay").text("Miles gained: " + miles);
	getRouteData(points, drawRoute);
}

function globalToLocal(p) {
	px = p[0];
	py = p[1];
	px -= mapCenter[0];
	py -= mapCenter[1];
	px *= -scalex;
	py *= scaley;
	px += 1/2;
	py += 1/2;
	px *= canvas.height;
	py *= canvas.width;
	return [py,px];
}

function localToGlobal(p) {
	px = p[0];
	py = p[1];
	px /= canvas.width;
	py /= canvas.height;
	px -= 1/2;
	py -= 1/2;
	px /= scaley;
	py /= -scalex;
	px += mapCenter[1];
	py += mapCenter[0];
	return [py,px];
}


function getRouteData(pointlist, fun, ind) {
	if (pointlist.length<2) {
	    var canvas = document.getElementById("canvas");
	    var ctx = canvas.getContext("2d");
	    ctx.clearRect(0, 0, canvas.width, canvas.height);
		lastInd = -1;
	    updateStraightLines(lastMouseX,lastMouseY);
        drawPassengerArrows();
	} else {
	  	var ghRouting = new GraphHopper.Routing({
	      key: "792f5935-6974-4c19-9ada-2742bbcdc54f",
	      vehicle: "car",
	      elevation: false
	    });

		var arrayLength = pointlist.length;
		for (var i = 0; i < arrayLength; i++) {
			ghRouting.addPoint(new GHInput(pointlist[i][0], pointlist[i][1]));
		}

	    ghRouting.doRequest().then(function(json) {
		    //console.log(json);
		    oldArr = json.paths[0].points.coordinates;
            totalDist = json.paths[0].distance;
            
	    //var miles = getFreeMiles(passengerList);
	    //alert(miles);
            //$(".incentiveDisplay").text("Miles gained: " + miles+"/lost: "+totalDist-directDist);
		    var res = [];
		    delta = 1;
		    for (i = 0; i < oldArr.length; i=i+delta) {
		        res.push(globalToLocal([oldArr[i][1],oldArr[i][0]]));
		    }
		    fun(res);
		    if (ind != -1) {
		        lastComputedInd = ind;
		        updateStraightLines(lastMouseX,lastMouseY);
            }
	    }).catch(function(err) {
		    console.error(err.message);
	    });
    }
}

function drawRoute(pointlist) {
    var canvas = document.getElementById("canvas");
    var ctx = canvas.getContext("2d");
	ctx.lineWidth=10;
	ctx.lineCap="round";
	ctx.strokeStyle = 'rgba(100,100,100,0.5)';
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.beginPath();
    ctx.moveTo(pointlist[0][0], pointlist[0][1]);

    pointlist.forEach(point => {
        ctx.lineTo(point[0], point[1]);
        ctx.stroke();
        ctx.moveTo(point[0], point[1]);
    });
    drawPassengerArrows();
}

/// Manage Passengers

class Passenger {
    constructor(location, incentive, targetlocation) {
        this.location = location;
	    this.targetlocation = targetlocation;
        this.active = false;
	    this.done = false;
	    this.count = -1;
	    this.tcount = -1;
        this.incentive = incentive;
    }
}



function getPassengers() {
//TODO: load CSV
    passengerList = [new Passenger(localToGlobal([550,50]), 4,localToGlobal([550,80])), 
                     new Passenger(localToGlobal([660,170]), 3,localToGlobal([500,80])),
		     new Passenger(localToGlobal([750,100]), 4,localToGlobal([650,80])), 
                     new Passenger(localToGlobal([660,130]), 3,localToGlobal([450,100])),
                     new Passenger(localToGlobal([750,350]), 0,localToGlobal([450,280]))];
    return passengerList;
}

function getFreeMiles(passengers){
	var miles = 0;
	passengers.forEach(passenger => {
		if(passenger.active && passenger.done){
			miles += passenger.incentive;
		}
	    });
	return miles;
}

function canvas_arrow(context, fromx, fromy, tox, toy){
    s = 5;
    fromx += s;
    fromy += s;
    tox += s;
    toy += s;
    var headlen = 10;   // length of head in pixels
    var angle = Math.atan2(toy-fromy, tox-fromx);
    context.moveTo(fromx, fromy);
    context.lineTo(tox, toy);
    context.lineTo(tox-headlen*Math.cos(angle-Math.PI/6),toy-headlen*Math.sin(angle-Math.PI/6));
    context.moveTo(tox, toy);
    context.lineTo(tox-headlen*Math.cos(angle+Math.PI/6),toy-headlen*Math.sin(angle+Math.PI/6));
}

function drawPassengerArrows(){
    var canvas = document.getElementById("canvas");
    var ctx = canvas.getContext("2d");
    ctx.beginPath();
	ctx.lineWidth = 10;
	ctx.lineCap = "round";
	ctx.strokeStyle = 'rgba(0,255,0,0.5)';

    passengerList.forEach(passenger => {
        st = globalToLocal(passenger.location);
        ta = globalToLocal(passenger.targetlocation);
        if (!passenger.active && !passenger.done) {
            canvas_arrow(ctx, st[0], st[1], ta[0], ta[1]);
        }
	    else if (!passenger.done){
	        //TODO: different color
	        canvas_arrow(ctx, st[0], st[1], ta[0], ta[1]);
	    }
    });
	ctx.stroke();
}

function drawPassengers(passengerList) {
    var body = document.getElementById("body");
    var canvas = document.getElementById("canvas");
    var ctx = canvas.getContext("2d");

    var radius = 5;

    ctx.lineWidth = 1;
    passengerList.forEach((passenger, index) => {
        var [x, y] = globalToLocal(passenger.location);
        passengerHTML = `<div class="passenger"
                              style="top: ` + y + `px; left: ` + x + `px;"
                              index="` + index + `"count="0"
                              >
                         </div>`;
        body.innerHTML += passengerHTML;

        var [tx, ty] = globalToLocal(passenger.targetlocation);
        passengertHTML = `<div id = "target`+ index +`" class="passengertarget"
                              style="top: ` + ty + `px; left: ` + tx + `px;"
                              index="` + index + `"count="0"
                              >
                         </div>`;
        body.innerHTML += passengertHTML;


    });
	//add start
    var [sx, sy] = globalToLocal(start);
    startHTML = `<div class="start"
                          style="top: ` + sy + `px; left: ` + sx + `px;"
                          >
                     </div>`;
    body.innerHTML += startHTML;

	//add target
    var [ttx, tty] = globalToLocal(target);
    targetHTML = `<div class="target" id="tFlag"
                          style="top: ` + tty + `px; left: ` + ttx + `px;"
                          >
                     </div>`;
    body.innerHTML += targetHTML;

    $(".passenger").on("click", function(e) {
        if (!finished) {
            var index = $(this).attr("index");
            if (passengerList[index].active == true && (passengerList[index].count==count-1 || passengerList[index].tcount==count-1)) {
                passengerList[index].active = false;
                passengerList[index].done = false;
            $("#target"+index).hide();
                $(this).css("background-image", "url('passengerGreen.png')");
            } else {
                $("#target"+index).show();
                passengerList[index].active = true;
                passengerList[index].count = count++;
                if (passengerList[index].done) {
                    passengerList[index].tcount = count++;
                }
                lastInd = index;
                lastType = 0;
                lastLoc = globalToLocal(passengerList[index].location);
                $(this).attr("count",count);
                $(this).css("background-image", "url('passengerYellow.png')");
            }
            //console.log(activePassengers());
            recomputeRoute(activePassengers());
        }
    });


    $(".passengertarget").on("click", function(e) {
        if (!finished) {
            var index = $(this).attr("index");
            $(this).css("background-image", "url('passengerYellowt.png')");;
            //TODO: launch animation
            lastInd = index;
            lastType = 1;
            lastLoc = globalToLocal(passengerList[index].targetlocation);
            if (passengerList[index].active) {
                passengerList[index].done = true;
            }
            passengerList[index].tcount = count++;
        recomputeRoute(activePassengers());}
    });
	$(".passengertarget").hide();

    $(".target").on("click", function(e){
        if (finished) {
            finished = 0;
        } else if (canFinish && !finished) {
            var canvas = document.getElementById("icanvas");
            var ctx = canvas.getContext("2d");
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            finished = 1;
        }
        recomputeRoute(activePassengers());
    });
}


function activePassengers() {
    var list = [];
    passengerList.forEach(passenger => {
        if (passenger.active) {
            list.push(passenger);
        }
    });
    return list;
}

</script>



<style>
  body {
      background-color: ivory;
      font-family: 'Quicksand', sans-serif;
      font-weight: bold;
      font-size: 20px;
  }

  .coveredImage {
      width:100%;
      height:100%;
      position:absolute;
      top:0px;
      left:0px;
      z-index: -1;
  }
  .coveringCanvas {
      width:100%;
      height:100%;
      position:absolute;
      top:0px;
      left:0px;
      background-color: rgba(255, 0, 0, 0);
      z-index: 0;
  }
  .passenger {
      position: absolute;
      width: 20px;
      height: 20px;
      background-image: url('passengerGreen.png');
      background-size: cover;
      z-index: 1;
      border-radius: 10px;
      box-shadow: 5px 5px 5px grey;
  }
  .start {
      position: absolute;
      width: 20px;
      height: 20px;
      background-image: url('passengerRed.png');
      background-size: cover;
      z-index: 1;
      border-radius: 10px;
      box-shadow: 5px 5px 5px grey;
  }
  .target {
      position: absolute;
      width: 20px;
      height: 20px;
      background-image: url('greenflag.png');
      background-size: cover;
      z-index: 1;
  }
  .passengertarget {
      position: absolute;
      width: 20px;
      height: 20px;
      background-image: url('passengerGreenT.png');
      background-size: cover;
      z-index: 1;
      border-radius: 10px;
      box-shadow: 5px 5px 5px grey;
  }
  .incentiveDisplay {
      width: 280px;
      height: 60px;
      background-color: white;
      border: 1px solid grey;
      border-radius: 5px;
      margin-top: 10px;
      padding-left: 20px;
      display: flex;
      align-items: center;
  }
  .options {
      position: absolute;
      width: 280px;
      height: 40px;
      background-color: rgb(108, 108, 224);
      border: 1px solid grey;
      color: white;
      z-index: 10;
      margin-top: 10px;
      padding-left: 20px;
      display: flex;
      align-items: center;
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      -khtml-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
  }
</style>
</head>
<body id="body" onload="onload()">
    <img id="map" src="http://staticmap.openstreetmap.de/staticmap.php?center=40.714728,-73.998672&zoom=14&size=1920x700&maptype=positron" class="coveredImage">
    <canvas id="canvas" class="coveringCanvas">
    </canvas>
    <canvas id="icanvas" class="coveringCanvas">
    </canvas>
    <div class="incentiveDisplay">
        Miles gained: 0
    </div>
    <div class="options" data-option="driver">
    </div>
</body>
</html>
