<html>
<head>
<meta charset="utf-8"/>
<script src="https://cdn.jsdelivr.net/npm/graphhopper-js-api-client/dist/graphhopper-client.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script type="text/javascript">
var scalex = 21;
var scaley = 11.5;
var mapCenter = [40.714728,-73.998672]
var canvasW;
var canvasH;
var passengerList;

function onload(){
     setup();
     passengerList = getPassengers();
     drawPassengers(passengerList);
     //drawRoute();
	testrouting();
}

function setup()
{
    map = document.getElementById("map");
    canvas = document.getElementById("canvas");
    canvas.width = document.body.clientWidth;
    canvas.height = document.body.clientHeight; 

    icanvas = document.getElementById("icanvas");
    icanvas.width = document.body.clientWidth;
    icanvas.height = document.body.clientHeight; 

    canvasW = canvas.width;
    canvasH = canvas.height;

    var ctx = canvas.getContext("2d");
    ctx.moveTo(0,0);
    ctx.lineTo(200,100);
    ctx.stroke();
}

function printMousePos(event) {
alert("clientX: " + event.clientX +
    " - clientY: " + event.clientY);
}

function testrouting(){
	var points = [[40.705086,-74.016711],
		[40.759967,-74.002850]];
	getRouteData(points, drawRoute)
}

function testpoint(p){
	var points = [[40.705086,-74.016711],
		localToGlobal(p)];
	getRouteData(points, drawRoute)
}

function recomputeRoute(passengers){
	var points = [[40.705086,-74.016711]];
	    passengers.forEach(passenger => {
		points.push(passenger.location);
	    });
	points.push([40.759967,-74.002850]);
	getRouteData(points, drawRoute);
}

function globalToLocal(p){
	px = p[0];
	py = p[1];
	px -= mapCenter[0];
	py -= mapCenter[1];
	px *= -scalex;
	py *= scaley;
	px += 1/2;
	py += 1/2;
	px *= canvasH;
	py *= canvasW;
	return [py,px];
}

function localToGlobal(p){
	px = p[0];
	py = p[1];
	px /= canvasW;
	py /= canvasH;
	px -= 1/2;
	py -= 1/2;
	px /= scaley;
	py /= -scalex;
	px += mapCenter[1];
	py += mapCenter[0];
	return [py,px];
}

function getRouteData(pointlist, fun){
  	var ghRouting = new GraphHopper.Routing({
      key: "792f5935-6974-4c19-9ada-2742bbcdc54f",
      vehicle: "car",
      elevation: false
    });
	var arrayLength = pointlist.length;
	for (var i = 0; i < arrayLength; i++) {
		ghRouting.addPoint(new GHInput(pointlist[i][0], pointlist[i][1]));
	}


    ghRouting.doRequest()
      .then(function(json) {
	console.log(json);
	oldArr = json.paths[0].points.coordinates;
	var res = [];
	delta = 1;
	for (i = 0; i < oldArr.length; i=i+delta) {
	  res.push(globalToLocal([oldArr[i][1],oldArr[i][0]]));
	}
	console.log(res);
	fun(res);
      })
      .catch(function(err) {
        console.error(err.message);
      });

}

function drawRoute(pointlist) {
    var canvas = document.getElementById("canvas");
    var ctx = canvas.getContext("2d");
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.beginPath();
    ctx.moveTo(pointlist[0][0], pointlist[0][1]);

    pointlist.forEach(point => {
        ctx.lineTo(point[0], point[1]);
        ctx.stroke();
        ctx.moveTo(point[0], point[1]);
    });
}

/// Manage Passengers

class Passenger {
    constructor(location, incentive) {
        this.location = location;
        this.active = false;
        this.incentive = incentive;
    }
}

function getPassengers() {
    passengerList = [new Passenger(localToGlobal([550,50]), 4), 
                     new Passenger(localToGlobal([660,170]), 3),
                     new Passenger(localToGlobal([1000,400]), 0)];
    return passengerList;
}

function drawPassengers(passengerList) {
    var body = document.getElementById("body");
    var canvas = document.getElementById("canvas");
    var ctx = canvas.getContext("2d");

    var radius = 5;

    ctx.lineWidth = 1;
    passengerList.forEach((passenger, index) => {
        var [x, y] = globalToLocal(passenger.location);
        passengerHTML = `<div class="passenger"
                              style="top: ` + y + `px; left: ` + x + `px;"
                              index="` + index + `"
                              >
                         </div>`;
        body.innerHTML += passengerHTML;
    });

    $(".passenger").attr("data-selected", "green");
    $(".passenger").on("click", function(e) {
        var index = $(this).attr("index");
        if (passengerList[index].active == true) {
            passengerList[index].active = false;
            $(this).css("background-image", "url('passengerGreen.png')");
        } else {
            passengerList[index].active = true;
            $(this).css("background-image", "url('passengerYellow.png')");
        }
        console.log(activePassengers());
	recomputeRoute(activePassengers());
    });
}

function activePassengers() {
    var list = [];
    passengerList.forEach(passenger => {
        if (passenger.active) {
            list.push(passenger);
        }
    });
    return list;
}

/// Manage UI



function passengerClick() {
    
}

</script>



<style>
  body {
      background-color: ivory;
  }

  .coveredImage {
      width:100%;
      height:100%;
      position:absolute;
      top:0px;
      left:0px;
      z-index: -1;
  }
  .coveringCanvas {
      width:100%;
      height:100%;
      position:absolute;
      top:0px;
      left:0px;
      background-color: rgba(255, 0, 0, .1);
  }
  .passenger {
      position: absolute;
      width: 20px;
      height: 20px;
      background-image: url('passengerGreen.png');
      background-size: cover;
      z-index: 1;
      border-radius: 10px;
      box-shadow: 5px 5px 5px grey;
  }
  .incentiveDisplay {
      width: 300px;
      height: 60px;
      background-color: white;
      border: 1px solid grey;
      border-radius: 5px;
  }
</style>
</head>
<body id="body" onload="onload()">
    <img id="map" src="http://staticmap.openstreetmap.de/staticmap.php?center=40.714728,-73.998672&zoom=14&size=1920x700&maptype=mapnik" class="coveredImage">
    <canvas id="canvas" class="coveringCanvas">
    </canvas>
    <canvas id="icanvas" class="coveringCanvas">
    <div class="incentiveDisplay">

    </div>
</body>
</html>
